# Vishlist — Социальный вишлист

Веб-приложение для создания списков желаний и координации подарков между друзьями. Владелец создаёт вишлист, делится ссылкой — друзья бронируют подарки и скидываются, не раскрывая сюрприз.

**[Открыть приложение →](#)** · **[Видео-демо →](#)**

---

## Стек

| Слой | Технология |
|------|-----------|
| Frontend | Next.js 15, React 19, Tailwind CSS v4, React Query, Zustand, Radix UI, Framer Motion |
| Backend | FastAPI (async), SQLAlchemy 2.0 (async), Alembic, asyncpg |
| База данных | PostgreSQL |
| Авторизация | JWT + Google OAuth |
| Realtime | WebSocket |
| Изображения | Vercel Blob |
| Деплой | Vercel (frontend) + Railway (backend + PostgreSQL) |

---

## Возможности

- **Вишлисты** — создание нескольких списков желаний (день рождения, Новый год, свадьба) с эмодзи-иконкой, датой события и описанием
- **Товары** — название, ссылка, цена, фото (загрузка с устройства или автозаполнение по URL), заметка от владельца. Перетаскивание для сортировки
- **Автозаполнение по ссылке** — вставляешь URL товара, приложение само подтягивает название, картинку и цену. Картинку можно заменить, загрузив свою
- **Публичная ссылка** — друзья открывают вишлист без регистрации, видят все товары и бронируют
- **Бронирование подарков** — друг вводит только имя и бронирует. Confetti-анимация при успехе. Владелец не видит кто забронировал — сюрприз сохранён
- **Групповые сборы** — если подарок дорогой, несколько друзей скидываются. Прогресс-бар, пресеты сумм
- **Realtime** — бронирования и вклады обновляются мгновенно через WebSocket, без перезагрузки
- **Google OAuth** — вход через Google в один клик, автоматическое объединение с email-аккаунтом
- **Обратный отсчёт** — «До дня рождения осталось 12 дней» на публичной странице
- **Шаринг** — нативное меню «Поделиться» на телефоне, копирование ссылки на десктопе
- **SEO-превью** — красивая карточка при отправке ссылки в мессенджер (название, описание, картинка)
- **Архивация** — завершённые вишлисты убираются в архив, не мешают в основном списке
- **Адаптивность** — мобильная версия с bottom sheets и нативным поведением
- **Кастомный дизайн** — собственная палитра (rose, coral, gold, mint), шрифты Playfair Display + Inter, кастомный favicon. Не дефолтный Tailwind

---

## Продуктовые решения

### Гостевой доступ без барьеров

Главный принцип — **минимум шагов**. Друг открывает ссылку и может забронировать подарок, введя только имя. Никакой регистрации.

После бронирования — экран подтверждения с необязательным полем email: «Куда отправить подтверждение?». Email не блокирует действие, а предлагается **после** него, когда человек уже заинтересован. Как в магазинах — «отправить чек на почту?».

Если email указан — гость получит письмо со ссылкой для отмены. Если нет — управление через localStorage. Потерял — владелец может сбросить бронь.

### Приватность владельца

Владелец видит **только статусы**: «Доступен», «Забронирован», «Сбор 60%», «Собрано!». Количество участников сбора — число, без имён. Общую собранную сумму — без разбивки. Имена, аватарки, индивидуальные суммы **скрыты**. Сюрприз сохранён.

Друзья при этом видят друг друга — кто забронировал, кто сколько скинул — чтобы координироваться между собой.

### Групповые сборы

Нет минимального вклада — любая сумма принимается. Это социальный инструмент, не платёжная система. Ввести больше остатка нельзя. При 100% — кнопка заменяется бейджем «Собрано!». Если кто-то отменит вклад — кнопка возвращается.

Сумма не набрана? Ничего не блокируется. Владелец видит «Сбор: 45%» и сам решает.

Первый вклад определяет режим товара: если кто-то скинулся — полное бронирование уже невозможно (только дополнительные вклады). Если все вклады отменены — товар снова доступен для любого действия.

### Отмена вместо подтверждений

Удаление товаров и вишлистов — без диалогов «Вы уверены?». Действие выполняется сразу, внизу появляется уведомление «Удалено · **Отменить**» на 5 секунд. Быстрее и современнее диалогов подтверждения.

Снятие брони — аналогично, но с отложенным запросом: DELETE на бэкенд отправляется только после таймаута. Кнопка «Отменить» отзывает запрос до его отправки.

### Realtime

Когда кто-то бронирует подарок или вносит вклад — остальные видят это мгновенно через WebSocket. Сообщения не содержат персональных данных (только тип события + ID товара), клиент запрашивает свежие данные через API, который фильтрует ответ по роли. Приватность сохраняется даже если владелец подключён к WS своего вишлиста.

Переподключение с exponential backoff, Page Visibility API (пауза при уходе со вкладки), отслеживание online/offline.

---

## Граничные случаи

### Бронирование и вклады

| Сценарий | Решение |
|----------|---------|
| Два человека бронируют одновременно | Оптимистичное обновление + UNIQUE constraint на `item_id`. Первый проходит, второй получает уведомление «Этот подарок уже забронирован» |
| Два вклада, сумма превышает цену | `SELECT FOR UPDATE` + проверка `SUM + new <= price` в транзакции. Второй получает 409 + уведомление «Кто-то только что скинулся! Осталось: X ₽» |
| Одновременное бронирование и вклад на один товар | `SELECT FOR UPDATE` на item — первая операция проходит, вторая видит актуальное состояние и получает 409 |
| Вклад при 100% сбора | Кнопка «Скинуться» скрыта, бейдж «Собрано!». При отмене чьего-то вклада — кнопка возвращается через WS |
| Товар без цены + кто-то хочет скинуться | Кнопка «Скинуться» недоступна. Только полное бронирование |
| Бронирование товара в архивном вишлисте | Backend: 403 «Вишлист архивирован». Frontend: кнопки скрыты + бейдж «Архив» |
| Владелец пытается забронировать свой товар | API: 403 «Нельзя бронировать товары в своём вишлисте». На фронте кнопки скрыты |

### Удаление и восстановление

| Сценарий | Решение |
|----------|---------|
| Удаление товара, на который уже скидывались или бронировали | Мягкое удаление + уведомление с кнопкой «Отменить» (5 сек). Данные сохраняются в БД |
| Удаление вишлиста с бронью и вкладами | Мягкое удаление + уведомление с кнопкой «Отменить». API возвращает 410 Gone для удалённого slug. Публичная страница: «Этот вишлист удалён». WS-оповещение `wishlist_deleted` |
| Редактирование цены после начала сбора | Разрешено. Прогресс пересчитывается. Если новая цена ≤ собранной суммы — статус «Собрано!» |

### Гостевой доступ

| Сценарий | Решение |
|----------|---------|
| Гость потерял localStorage (указывал email) | Кнопка «Я уже бронировал тут» → ввод email → письмо со ссылками управления → `guest_token` восстановлен |
| Гость потерял localStorage (без email) | Бронь остаётся, но гость не может её снять. Владелец может сбросить вручную |
| Гость указывает разные имена на разных вишлистах | `guest_token` изолирован per-wishlist (`guest_token_{slug}`). Активность между вишлистами не пересекается |

### Аккаунты и авторизация

| Сценарий | Решение |
|----------|---------|
| Регистрация по email, потом вход через Google с тем же email | Merge: OAuth привязывается к существующему аккаунту, дубликат не создаётся |
| OAuth-пользователь пытается зарегистрироваться по email | 409 «Этот email уже используется. Войдите через Google» |
| Email в разном регистре | `email.lower().strip()` перед сохранением и поиском |
| Пользователь удаляет аккаунт | Вишлисты удаляются (cascade). Бронь гостей на чужих вишлистах остаётся |
| Google OAuth не настроен на сервере | Если не настроен — кнопка «Войти через Google» скрыта на фронте |

### Контент и отображение

| Сценарий | Решение |
|----------|---------|
| Картинка товара не загрузилась | `next/image` onError → SVG-заглушка в стиле палитры |
| Очень длинное название товара | `line-clamp-2` + полное название в tooltip |
| Много товаров (50+) | Infinite scroll на публичной странице, пагинация на dashboard |
| Несуществующая ссылка на вишлист | 404 с кнопкой «На главную» |

### Безопасность

| Сценарий | Решение |
|----------|---------|
| XSS через имя гостя | Backend: очистка HTML-тегов, max 50 символов, regex. React экранирует по умолчанию |
| SSRF через URL-парсер (localhost, приватные IP) | Только http/https, блокировка приватных диапазонов (127.0.0.0/8, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16) |
| URL-парсер: сайт отдаёт 30+ МБ HTML | httpx timeout 5s + ограничение 1 МБ |
| Перебор паролей | Rate limiting: 5 попыток/мин на вход, 3/мин на регистрацию |
| Resend API не настроен | Если не настроен — логирование вместо отправки. Приложение работает без email |

---

## Пустые состояния

- **Dashboard без вишлистов** — иллюстрация + «У вас пока нет вишлистов» + CTA «Создать первый вишлист»
- **Вишлист без товаров (владелец)** — «Здесь пока пусто» + «Добавить первое желание» + подсказка про автозаполнение по ссылке
- **Вишлист без товаров (гость)** — «Владелец ещё не добавил желания. Загляните позже!»
- **Архивные вишлисты** — приглушённый вид (opacity), бейдж «Архив», показываются после активных

---

## Локальный запуск

### Требования
- Node.js 18+
- Python 3.12+
- PostgreSQL

### Backend

```bash
cd backend
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env  # заполнить DATABASE_URL, SECRET_KEY
alembic upgrade head
uvicorn app.main:app --reload
```

### Frontend

```bash
cd frontend
npm install
cp .env.example .env.local  # заполнить NEXT_PUBLIC_API_URL
npm run dev
```

Приложение: [http://localhost:3000](http://localhost:3000)
API: [http://localhost:8000/docs](http://localhost:8000/docs)

---

## Архитектура

```
frontend/          Next.js 15 (App Router, RSC + Client Components)
├── app/           Страницы и layouts
├── components/    UI-компоненты (переиспользуемые)
├── hooks/         React-хуки (useAuth, useRealtime, useGuestToken...)
├── lib/           API-клиент, WebSocket, утилиты
└── types/         TypeScript-типы

backend/           FastAPI (async)
├── app/api/       Endpoints (auth, wishlists, items, reservations...)
├── app/core/      Config, security, database
├── app/models/    SQLAlchemy-модели
├── app/schemas/   Pydantic v2 схемы
├── app/utils/     URL-парсер, WebSocket manager, slug, email
└── alembic/       Миграции
```
